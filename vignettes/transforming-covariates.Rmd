---
title: "Transforming Covariates"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Transforming Covariates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

*Built using Zelig version `r packageVersion('Zelig')`*

```{r setup, include=FALSE}
knitr::opts_knit$set(
        stop_on_error = 2L
)
```

> NOTE: this vignette is under construction.

For convienience, you may wish to transform one or more of your covariates within the `zelig` model estimation call. For example, imagine we want to natural log transform the variable `dist` in a linear regression:

```{r}
library(Zelig)
library(dplyr)

z.log <- zelig(speed ~ log(dist), data = cars, model = 'ls', cite = FALSE)
```

Then we want to find quantities of interest when the `dist` variable is 26 to
56 (the first to third quartile). To do this we added the logged fitted values 
to `setx`, simulate quantites of interest, and plot the results:

```{r}
setx(z.log, dist = log(26:56)) %>%
    sim() %>%
    plot(xlab = 'dist (log)') 
```

## In development 

The ability to transform covariates in the `zelig` model formula and then set/simulate 
quantities of interest is currently in development. `zelig` only supports `log` and `as.factor`. 
Interactions are created in the `zelig` call are also evaluated correctly without additional considerations
in `setx`. We aim to introduce more transformations in the future. 

## Currently unsupported transformations

In the meantime. You can transform the covariates outside of the `zelig` model estimation call.
For example, we could start by creating a second order polynomial of the `dist`
variable:

```{r}
cars.poly <- cbind(cars, I(cars$dist^2))
names(cars.poly)[3] <- 'dist_2'

head(cars.poly)
```

Now include this in the `zelig` call and `setx for both the base and second order 
polynomial version of the `dist` variable:

```{r, message=FALSE}
dist_range <- 26:56
qis <- zelig(speed ~ dist + dist_2, data = cars.poly, model = 'ls', cite = FALSE) %>%
    setx(dist = dist_range, dist_2 = dist_range^2) %>%
    sim() %>%
    zelig_qi_to_df() %>%
    qi_slimmer() 
```

Note that we used `zelig_qi_to_df` and `qi_slimmer` to extract the central simulation
interval of the quantites of interest.

We can plot these values with ggplot2:

```{r}
ggplot(qis, aes(dist, qi_ci_median)) +
    geom_ribbon(aes(ymin = qi_ci_min, ymax = qi_ci_max), alpha = 0.3) +
    geom_line() + 
    ylab('Expected speed') + xlab('Distance') +
    theme_bw()
```

